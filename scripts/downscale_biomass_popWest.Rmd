---
title: "DisaggregateByFeedstock"
output: html_document
---

```{r LOAD LIBRARIES, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## load libraries
library(tidyr)
library(dplyr)
library(stringr)
library(readxl)
library(stats)
```

# Read csvs and tidy up the column names and data
```{r}

supplies <- read.csv("BiomassSuppliesbyState.csv", header= TRUE)
mapping <- read.csv("stateToRegionMapping.csv", header=TRUE)
use_orig <- read_excel("OriginalInputs/biomass use by zone - adjusted.xlsx")
derate <- read.csv("BiomassSupplyDeratesPU_NZA.csv", header=TRUE)
herb75 <- read_excel("OriginalInputs/herb 75 (corn land conversion) potential_interpolated.xlsx")
consump <- read_excel("OriginalInputs/biomass allocated by consumption - Grace.xlsx")
uspop <- read.csv("USpopulation.csv")
lu_factors <- read.csv("/Users/grace/Documents/PathTo100_West/Paper/paperFigures/landUseFactors.csv") 
  
## change colnames as needed
colnames(supplies)
colnames(mapping)
colnames(mapping) <- c("state", "zone", "allocator")
colnames(use_orig)
colnames(use_orig) <- c("Fuel", "Run.Name", "Year", "zone", "Mil.Dry.Tons.Use.zone")
colnames(consump)
colnames(consump)<- c("Fuel", "Run.Name", "Year", "zone", "Mil.Dry.Tons.Consum.zone")
  
## clean up state names (they don't match between the tables because of capitalization)
supplies <- supplies %>% 
  mutate(State = tolower(State))

### check that state names are the same (that the supply curve states are in the mapping table)
unique(supplies$State) %in% unique(mapping$state)

### check that resources in derate are the same resources in supplies
unique(supplies$Resource) %in% unique(derate$Resource)

## remove commas and convert factors to numeric
supplies$Dry.Tons <- as.numeric(as.character(gsub(",", "", supplies$Dry.Tons)))
```
# PREP SUPPLIES TABLE

## Join mapping to supplies table
This gets the mapping[alloctator] column into the supplies table 
```{r}
n.before <- nrow(supplies)
supplies_zones <- left_join(supplies, mapping, by = c("State" = "state"))
n.after <- nrow(supplies_zones)
n.before - n.after

## multiply the Dry.Tons by the allocator
supplies_zones <- supplies_zones %>% 
  mutate(Dry.Tons.Alloc = Dry.Tons*allocator)
```

## In base supplies table: remove unnecessary years and duplicate 2040 for 2045 and 2050
1) remove unnecessary years
2) duplicate 2040 for 2045 and 2050
```{r}
unique(supplies_zones$Year)
#unique(use$Year)

## in supplies_zones: remove all unnecessary years (in between the five year increments)
supplies_zones_sub <- supplies_zones %>% 
  filter(Year %in% unique(use$Year))

nrow(supplies_zones_sub)

## duplicate 2040 for 2045 and 2050 in supply curve
supplies_zones_sub_dup <- rbind(supplies_zones_sub, 
                            supplies_zones_sub %>% 
                              filter(Year == 2040) %>%
                              mutate(Year = 2045))

supplies_zones_sub_dup <- rbind(supplies_zones_sub_dup, 
                            supplies_zones_sub_dup %>% 
                              filter(Year == 2040) %>%
                              mutate(Year = 2050))

nrow(supplies_zones_sub_dup)
unique(supplies_zones_sub_dup$Year)

## Check that it has the right number of rows
nrow(filter(supplies_zones_sub_dup, Year == 2040))*2 + nrow(supplies_zones_sub) == nrow(supplies_zones_sub_dup)

#write.csv(supplies_zones_sub_dup, "supplies_zones_sub_dup.csv")
```
## Create supply curves per siting level
```{r}
# Add column for each siting level,  apply derate for SL2 and 3 and add the herb 75 supply curve, 

## prep herb 75

### Calculate the sum of miscanthus and switchgrass from the original BT supply curve for price = 100, year 2040 (this year and price has all states with some supply of miscanthus or switchgrass)
supplies_zones_sub_dup_misswi <- supplies_zones_sub_dup %>%
  filter(Year == 2040 & Biomass.Price == 100 & Resource.Form == "Herbaceous" &  (Resource == "Miscanthus" | Resource == "Switchgrass")) 

supplies_zones_sub_dup_misswi_sum <- supplies_zones_sub_dup_misswi %>%
  group_by(Biomass.Price, Resource.Form, Year, State, allocator) %>%
  summarise(sum.Dry.Tons.Alloc = sum(Dry.Tons.Alloc))

## join sums (denominator) to supplies_zones_sub_dup
supplies_zones_sub_dup_misswi <- supplies_zones_sub_dup_misswi %>%
  left_join(supplies_zones_sub_dup_misswi_sum, by = c("Biomass.Price" = "Biomass.Price", "Resource.Form" = "Resource.Form", "State" = "State", "Year" = "Year", "allocator" = "allocator")) %>%
  mutate(misSwi.allocator = Dry.Tons.Alloc/sum.Dry.Tons.Alloc) %>%
  select(c(Resource, State, misSwi.allocator, allocator, zone))

## convert NaNs to zeros due to 0/0 division
supplies_zones_sub_dup_misswi$misSwi.allocator[is.nan(supplies_zones_sub_dup_misswi$misSwi.allocator)]<-0
                                        
### process herb 75 supply curve and calculate dry tons for miscanthus and switchgrass
herb75_sc <- herb75 %>%
  ## convert PJ to tons using 18.7 GJ/ton and 10^6 GJ per PJ
  mutate(Dry.Tons = value*10^6/18.7) %>%
  ### select just the princeton sensitivity
  filter(sensitivity == "princeton") %>%
#  left_join(mapping, by = c("gau" = "state")) %>%
  ## multiply the Dry.Tons by the allocator
#  mutate(Dry.Tons.Alloc = Dry.Tons*allocator) %>%
  ## add columns for resource and price
  mutate(Resource.Form = "Herbaceous", Biomass.Price = "75") %>%
  left_join(supplies_zones_sub_dup_misswi, by = c("gau" = "State")) %>%
  mutate(Dry.Tons.Alloc = Dry.Tons*misSwi.allocator) %>%
  rename(State = gau, Year = year) %>%
  select(colnames(supplies_zones_sub_dup))

herb75_sc$Biomass.Price <- as.integer(herb75_sc$Biomass.Price)
####################
## CREATE INDIVIDUAL SUPPLY CURVES FOR EACH SL

# SL1: add herb75_sc
supplies_zones_sub_dup_SL1 <- supplies_zones_sub_dup %>%
  rbind(herb75_sc) %>%
  mutate(sitingLevel = "1")

# SL 2 and 3: derate and then add herb75_sc
n.before <- nrow(supplies_zones_sub_dup)
supplies_zones_sub_dup_SL2 <- supplies_zones_sub_dup %>%
  left_join(select(derate, -c(Resource.Form)), by = c("Resource" = "Resource")) %>%
  mutate(Dry.Tons.Alloc = Dry.Tons*allocator*derate) %>%
  select(-derate) %>%
  rbind(herb75_sc) %>%
  mutate(sitingLevel = "2")

supplies_zones_sub_dup_SL3 <- supplies_zones_sub_dup_SL2 %>%
  mutate(sitingLevel = "3")

n.after <- nrow(supplies_zones_sub_dup_SL2)
n.before - n.after

# Low biomass: 
supplies_zones_sub_dup_lowBIO <- supplies_zones_sub_dup %>%
  left_join(select(derate, -c(Resource.Form)), by = c("Resource" = "Resource")) %>%
  mutate(Dry.Tons.Alloc = Dry.Tons*allocator*derate) %>%
  select(-derate) %>%
  mutate(sitingLevel = "lowBIO")
 
####################
## COMBINE INDVIDUAL SUPPLY CURVES
supplies_final <- bind_rows(list(supplies_zones_sub_dup_SL1, supplies_zones_sub_dup_SL2, supplies_zones_sub_dup_SL3, supplies_zones_sub_dup_lowBIO))

```

## get national sums by resource form using biomass use csv
```{r}
use.national <- use %>%
  group_by(Fuel, Run.Name, Year) %>%
  summarize(Dry.Tons.Use.national = sum(Dry.Tons.Use.zone))
write.csv(use.national, paste0("OUTPUTS/national_use_resourceForm.csv"))
```

## Calculate allocation proportions for each resource within each resource form
```{r}
## get denominator (allocated and derated total dry tons for each RESOURCE FORM, year, zone, and price) from supply curve
sum.Dry.Tons.Alloc <- supplies_final %>% 
  group_by(Biomass.Price, Resource.Form, Year, zone, sitingLevel) %>%
  summarise(sum.Dry.Tons.Alloc = sum(Dry.Tons.Alloc))

## join sums (denominator) back to supplies_final
supplies_final.alloc <- supplies_final %>%
  left_join(sum.Dry.Tons.Alloc, by = c("Biomass.Price" = "Biomass.Price", "Resource.Form" = "Resource.Form", "zone" = "zone", "Year" = "Year", "sitingLevel" = "sitingLevel")) %>%
  ## Divide Dry.Tons.Alloc (numerator) by sum.Dry.Tons.Alloc (denominator)
  mutate(use.allocator = Dry.Tons.Alloc/sum.Dry.Tons.Alloc)

## Clean up other loose ends
# make Resource.Form in supplies table lowercase to match use table
supplies_final.alloc <- supplies_final.alloc %>%
  mutate(Resource.Form = tolower(Resource.Form))
unique(supplies_final.alloc$Resource.Form)

```


# PREP USE TABLE
```{r}
use <- use_orig %>% 
  ## separate the resource form from the price
  separate(Fuel, c("Resource.Form", "Biomass.Price"), sep = "_", remove = TRUE) %>% 
  ## Isolate resource form by deleting "biomass primary - "
  mutate(Resource.Form = gsub("biomass primary - ", "", Resource.Form)) %>%
  ## isolate siting level from Run.Name
  mutate(sitingLevel = ifelse(Run.Name == "reference", 1 , as.numeric(str_extract(Run.Name, "(?<=level\\s)\\d+")))) %>%
  mutate(sitingLevel = ifelse(Run.Name == "high elec level 3 lowBIO", "lowBIO", sitingLevel)) %>%
  ## convert millions of dry tons to dry tons
  mutate(Dry.Tons.Use.Zone = Mil.Dry.Tons.Use.zone * 10^6) %>%
  select(-Mil.Dry.Tons.Use.zone)

unique(use$Resource.Form)
nrow(use)

## delete Resource.Form == "corn" rows
use <- use %>% 
  filter(Resource.Form != "corn")
##check that rows were removed
unique(use$Resource.Form)
nrow(use)

## ERR, it's "woody" in supplies table and "wood" in the use table! replace "wood" with "woody" in use table in the Resource.Form column
use <- use %>%
  mutate(Resource.Form = replace(Resource.Form, Resource.Form == "wood", "woody"))

## ALSO, Biomass.Price is a character. make it numeric:
use$Biomass.Price <- as.numeric(use$Biomass.Price)
```

# CALCULATE USE BY RESOURCE 

## join use table to supplies_final.alloc and multiply use by use.allocator
This allow the use.allocator to be applied to the Dry.Tons.Use.zone (selected tons of biomass in each scenario) to calculate the per state resource allocation.
```{r}
## Now we can do the join:
supplies_final.alloc.use <- left_join(supplies_final.alloc, use, by = c("Biomass.Price" = "Biomass.Price", "Resource.Form" = "Resource.Form", "zone" = "zone", "Year" = "Year", "sitingLevel" = "sitingLevel"))
```

## Calculate the disaggregated biomass usage numbers by lowest dimension (resource within each state), saved as column, Dry.Tons.Use.State
```{r}
## Convert all NaNs in the use.allocator (which are 0/0) to 0
supplies_final.alloc.use[is.nan.data.frame(supplies_final.alloc.use)] <- 0

supplies_final.alloc.use <- supplies_final.alloc.use %>%
  mutate(Dry.Tons.Use.zone.resource = use.allocator*Dry.Tons.Use.Zone)

#write.csv(supplies_zones_sub_dup_use, "supplies_zones_sub_dup_use.csv")
```

## Get national use sums by Resource
```{r}
national_resource <- supplies_final.alloc.use %>%
  group_by(Resource, Resource.Form, Run.Name, Year, sitingLevel) %>%
  summarise(Dry.Tons.ByResource = sum(Dry.Tons.Use.zone.resource))

write.csv(national_resource, "OUTPUTS/national_resource.csv")
```

# ALLOCATE NATIONAL SUMS BY ZONE USING CONSUMPTION
```{r}
## Calculate national consumption sums per scenario year
consump.sums <- consump %>%
  group_by(Run.Name, Year) %>%
  summarise(sum.Dry.Tons.Consum.all = sum(Mil.Dry.Tons.Consum.zone)*10^6)

## calculate zonal sums per scenario year
consump.zones <- consump %>%
  group_by(Run.Name, Year, zone) %>%
  summarise(sum.Dry.Tons.Consum.zone = sum(Mil.Dry.Tons.Consum.zone)*10^6)

## calculate allocation per zone, scenario, year
consump.sums.alloc <- consump.zones %>%
  left_join(consump.sums, by = c("Run.Name" = "Run.Name", "Year" = "Year")) %>%
  mutate(consum.allocator = sum.Dry.Tons.Consum.zone/sum.Dry.Tons.Consum.all)
  
## apply consumption allocation to national use sums by resource
national_resource.consumpByZone <- national_resource %>%
  left_join(consump.sums.alloc, by = c("Run.Name" = "Run.Name", "Year" = "Year")) %>%
  mutate(Dry.Tons.ByResource.zone = Dry.Tons.ByResource*consum.allocator)

## save this to csv
write.csv(national_resource.consumpByZone, "OUTPUTS/national_resource_consumpByZone.csv")
```
# CALCULATE AREA OF BIOMASS PER SCENARIO AND YEAR
```{r}
## WECC states and other states
national_resource.area <- national_resource.consumpByZone %>%
  ## join the land use factor table
  left_join(lu_factors, by = c("Resource" = "Technology")) %>%
  ## calculate the hectares and ha 
  mutate(ha = Dry.Tons.ByResource.zone/landUseFactor, km2 = Dry.Tons.ByResource.zone/landUseFactor*0.01) %>%
  group_by(Run.Name, Year, zone, sitingLevel) %>%
  summarise(ha = sum(ha, na.rm=TRUE), km2 = sum(km2, na.rm=TRUE))

## save this to csv
write.csv(national_resource.area, "OUTPUTS/national_resource_area_byState.csv")


## WECC total and otherstates
national_resource.area.byWECCvsOtherStates <- national_resource.consumpByZone %>%
  ## join the land use factor table
  left_join(lu_factors, by = c("Resource" = "Technology")) %>%
  mutate(zone = ifelse(zone == "other states", "other states", "WECC")) %>%
  ## calculate the hectares and ha 
  mutate(ha = Dry.Tons.ByResource.zone/landUseFactor, km2 = Dry.Tons.ByResource.zone/landUseFactor*0.01) %>%
  group_by(Run.Name, Year, zone, sitingLevel) %>%
  summarise(ha = sum(ha, na.rm=TRUE), km2 = sum(km2, na.rm=TRUE))

## save this to csv
write.csv(national_resource.area.byWECCvsOtherStates, "OUTPUTS/national_resource_area_byStudyRegion.csv", row.names = FALSE)


## WECC total and otherstates by resoure form
national_resource.area.byWECCvsOtherStates.resourceform <- national_resource.consumpByZone %>%
  ## join the land use factor table
  left_join(lu_factors, by = c("Resource" = "Technology")) %>%
  mutate(zone = ifelse(zone == "other states", "other states", "WECC")) %>%
  ## calculate the hectares and ha 
  mutate(ha = Dry.Tons.ByResource.zone/landUseFactor, km2 = Dry.Tons.ByResource.zone/landUseFactor*0.01) %>%
  group_by(Run.Name, Year, zone, Resource.Form, sitingLevel) %>%
  summarise(ha = sum(ha, na.rm=TRUE), km2 = sum(km2, na.rm=TRUE))

## save this to csv
write.csv(national_resource.area.byWECCvsOtherStates.resourceform, "OUTPUTS/national_resource_area_byStudyRegionAndresourceForm.csv", row.names = FALSE)

## nationally by resource form
national_resource.area.byResourceForm <- national_resource.consumpByZone %>%
  ## join the land use factor table
  left_join(lu_factors, by = c("Resource" = "Technology")) %>%
  ## calculate the hectares and ha 
  mutate(ha = Dry.Tons.ByResource.zone/landUseFactor, km2 = Dry.Tons.ByResource.zone/landUseFactor*0.01) %>%
  group_by(Run.Name, Year, Resource.Form, sitingLevel) %>%
  summarise(ha = sum(ha, na.rm=TRUE), km2 = sum(km2, na.rm=TRUE))

## save this to csv
write.csv(national_resource.area.byResourceForm, "OUTPUTS/national_resource_area_resourceForm.csv", row.names = FALSE)

```

# ALLOCATE NATIONAL SUMS BY ZONE USING POPULATION
```{r}

## apply consumption allocation to national use sums by resource
national_resource.byPop <- national_resource %>%
  left_join(uspop, by = c("Year" = "Year")) %>%
  mutate(Dry.Tons.ByResource.zone = Dry.Tons.ByResource*pop.allocator)

## save this to csv
write.csv(national_resource.byPop, "OUTPUTS/national_resource_byPop.csv")
```

# CALCULATE AREA OF BIOMASS PER SCENARIO AND YEAR
```{r}
## WECC states and other states
national_resource_pop.area <- national_resource.byPop %>%
  ## join the land use factor table
  left_join(lu_factors, by = c("Resource" = "Technology")) %>%
  ## calculate the hectares and ha 
  mutate(ha = Dry.Tons.ByResource.zone/landUseFactor, km2 = Dry.Tons.ByResource.zone/landUseFactor*0.01) %>%
  group_by(Run.Name, Year, state, sitingLevel) %>%
  summarise(ha = sum(ha, na.rm=TRUE), km2 = sum(km2, na.rm=TRUE))

## save this to csv
write.csv(national_resource_pop.area, "OUTPUTS/national_resource_pop_area_byState.csv")


## WECC total and otherstates
national_resource_pop.area.byWECCvsOtherStates <- national_resource.byPop %>%
  ## join the land use factor table
  left_join(lu_factors, by = c("Resource" = "Technology")) %>%
  mutate(state = ifelse(state == "other states", "other states", "WECC")) %>%
  ## calculate the hectares and ha 
  mutate(ha = Dry.Tons.ByResource.zone/landUseFactor, km2 = Dry.Tons.ByResource.zone/landUseFactor*0.01) %>%
  group_by(Run.Name, Year, state, sitingLevel) %>%
  summarise(ha = sum(ha, na.rm=TRUE), km2 = sum(km2, na.rm=TRUE))

## save this to csv
write.csv(national_resource_pop.area.byWECCvsOtherStates, "OUTPUTS/national_resource_pop_area_byStudyRegion.csv", row.names = FALSE)


## WECC total and otherstates by resoure form
national_resource_pop.area.byWECCvsOtherStates.resourceform <- national_resource.byPop %>%
  ## join the land use factor table
  left_join(lu_factors, by = c("Resource" = "Technology")) %>%
  mutate(state = ifelse(state == "other states", "other states", "WECC")) %>%
  ## calculate the hectares and ha 
  mutate(ha = Dry.Tons.ByResource.zone/landUseFactor, km2 = Dry.Tons.ByResource.zone/landUseFactor*0.01) %>%
  group_by(Run.Name, Year, state, Resource.Form, sitingLevel) %>%
  summarise(ha = sum(ha, na.rm=TRUE), km2 = sum(km2, na.rm=TRUE))

## save this to csv
write.csv(national_resource_pop.area.byWECCvsOtherStates.resourceform, "OUTPUTS/national_resource_area_pop_byStudyRegionAndresourceForm.csv", row.names = FALSE)

```

# REVISIONS (5/30/22)
## calculate the amount of biomass that Western states consumed (by population) and where the biomass would be sourced: multiply the Western population share/alloc  (23.2% : 76.8%) by the supplies_final.alloc.use (how much of supply curve was demanded/used/harvest by resource, zone, year, scenario).
It is possible to interpret this as the state level (including with the other states zone) since "use" has been allocated using the supply curve
```{r}
WECCpopAlloc <- 0.232
supplies_final.alloc.use_WECC <- supplies_final.alloc.use %>%
  mutate(Dry.Tons.Use.zone.resource_WECConly = Dry.Tons.Use.zone.resource*WECCpopAlloc) %>%
  ## sum across Biomass.price
  group_by(Resource, Resource.Form, State, Run.Name, Year, sitingLevel) %>%
  summarise(SUM_Dry.Tons.Use.zone.resource_WECConly = sum(Dry.Tons.Use.zone.resource_WECConly))

## Calculate the land area

use.area.byState <- supplies_final.alloc.use_WECC %>%
  ## join the land use factor table
  left_join(lu_factors, by = c("Resource" = "Technology")) %>%
  ## calculate the hectares and ha 
  mutate(ha = SUM_Dry.Tons.Use.zone.resource_WECConly/landUseFactor, km2 = SUM_Dry.Tons.Use.zone.resource_WECConly/landUseFactor*0.01) %>%
  group_by(Resource.Form, Run.Name, Year, State, sitingLevel) %>%
  summarise(ha = sum(ha, na.rm=TRUE), km2 = sum(km2, na.rm=TRUE))
## save to csv
write.csv(use.area.byState, "OUTPUTS/use.area.byState_WECConly.csv", row.names = FALSE)

## check that this is consistent with the method used to create Figure 1 by summing across all states (nationally)
use.area.nationally <- supplies_final.alloc.use_WECC %>%
  ## join the land use factor table
  left_join(lu_factors, by = c("Resource" = "Technology")) %>%
  ## calculate the hectares and ha 
  mutate(ha = SUM_Dry.Tons.Use.zone.resource_WECConly/landUseFactor, km2 = SUM_Dry.Tons.Use.zone.resource_WECConly/landUseFactor*0.01) %>%
  group_by(Resource.Form, Run.Name, Year, sitingLevel) %>%
  summarise(ha = sum(ha, na.rm=TRUE), km2 = sum(km2, na.rm=TRUE))
```

