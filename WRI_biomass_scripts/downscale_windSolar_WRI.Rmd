---
title: "Downscaling - wind and solar - WRI sustainable biomass RIO runs"
author: "Grace Wu"
date: "01/09/2023"
output: html_document
---

Downscaling script has been modified from the Power of Place National script for wind and solar technologies

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## load packages
library(dismo)
library(sp)
library(sf)
require(rgdal)
library(raster)
library(fasterize) ## convert sf polygons to raster
library(ggplot2)
library(dplyr)
#library(gdalUtils) <-- not available in this version of R
#library(tmap)
library(maptools)
require(rgeos)
library(stringr)
library(tidyverse)
library(tictoc)
library(egg)
## import raster from gdb into r using arcgisbinding library (https://gis.stackexchange.com/questions/267186/importing-raster-with-r-from-file-geodatabase)
#library(arcgisbinding) # https://github.com/R-ArcGIS/r-bridge/releases/tag/v1.0.1.232
# install.packages("arcgisbinding", repos="https://r.esri.com", type="win.binary")
#arc.check_product()
# install.packages("stringi", dependencies=TRUE, INSTALL_opts = c('--no-lock'))
```

Pseudo-code:
1. input parameters and set folder paths
2. import data
    a. import bins/mergedCPAs (csv) as df
    b. import RIO portfolios/results (capacity) (csv) as df
    c. import prediction values for each UNIQUEID CPA (csv) as df
3a Get prediction value of each CPA <-- do this in python (create multi-tech CPA script)
    a. project random forest rasters
    b. Create a numeric field of unique IDs for rasterizing
    c. convert to raster
    d. Fix extent
    e. get average prediction value for each CPA (using zonal stats, with CPAs as zones and pg as raster input) as a data frame
3b. join prediction values dataframe to the bins/mergedCPAs df
    a. add column and calculate the average wind/solar score for colocation/trilocation
4. Select CPAs for each scenario
    a. SORT CPAS BY PREDICTION SCORE FOR EACH BIN FOR EACH REGION; for each unique scenario and year combination, select the CPAs
        i. This selected df needs to have the uniqueid and tech
    b. save as csv
        i. import in python and select polygons from mergedCPA feature class using select query for each tech (create separate feature class per technology)
    
########################################
# STEP 1. INPUT PARAMETERS FOR EACH TECH AND SET FOLDER PATHS
```{r}
## NOTE: currently programmed to select the highest scores first within each bin
sortBy <- "highest" # "lowest" (for LCOE); "highest" for random forest and other machine learning prediction
year.list <- c(2035, 2050) #unique(rio_sub$year)

## main google shared folder path:
google_fp <- "/Users/grace/Library/CloudStorage/GoogleDrive-gracecwu@ucsb.edu/My Drive/Research_Projects/WRI_biomass"
popNat_google_fp <- "/Users/grace/Library/CloudStorage/GoogleDrive-gracecwu@ucsb.edu/Shared drives/PoP_National/PoPNational_Data/0_Deliverables/multiTech_supplyCurve/Sept2023_updated"

rioResultsFolder_fp <- file.path(google_fp, "RIO_data/PreliminaryResults")
#mergedCPAs_folderName <- "mergedCPAs_focalStats_v2"
zonalStats_folderName <- "zonalStatsCSVs_focalStats_v2"
leastCostPath_folderName <- "leastCostPath_focalStats_v2"
rf_field_PV <- "rf_pl_PV"
rf_field_wind <- "rf_pl_wind"

## outputs folder:
outputsFolder <- "../outputs/csvs_011024/"
outputsFolder_shp <- "../outputs/shp_011024/"
outputsFolder <- file.path(google_fp, "Downscaling/script_outputs/csvs_011024/")
outputsFolder_shp <- file.path(google_fp, "Downscaling/script_outputs/shp_011024/")
## list of CPA attributes to keep in output shapefile
keepFieldsList <- c("ID", "STATE_sub", "tot_txCost", "UNIQUEID", "CF_wind", "CF_fixed", "CF_track", "env_wind_i10", "env_PV_i10", "env_APV", "soc_PV", "soc_wind", "soc_APV", "spur_tx_cost", "rf_PV", "rf_wind", "rf_both", "pov", "unemp", "minrty", "nohsdp", "tech") # + SCENARIO!
keepFieldsList <- c("ID", "STATE_sub", "tot_txCost", "UNIQUEID", "CF_wind", "CF_fixed", "CF_track", "env_wind_i10", "env_PV_i10", "env_APV", "soc_PV", "soc_wind", "spur_tx_cost", "rf_PV", "rf_wind", "rf_both", "tech") # + SCENARIO!

```

########################################
# STEP 2: Import prediction surfaces, RIO bins csv, RIO results csv, merged CPA as shapefile and raster
```{r}
#######################
# IMPORT PREDICTION SURFACES

## placeholder for prediction surfaces 
# pred_PV <- read.csv(file.path(google_fp, "Downscaling/downscaling_inputs/Wind_solar_predictionSurfaces/XXXX.csv"))

# pred_wind <- read.csv(file.path(google_fp, "Downscaling/downscaling_inputs/Wind_solar_predictionSurfaces/XXXX.csv")) 


#######################
# IMPORT RIO RESULTS
## Import RIO capacity results
rio_cap <- read.csv(file.path(rioResultsFolder_fp, "capacity_y.csv"))
head(rio_cap)
rio_tech_list <- unique(rio_cap$tech)

## Import RIO resource bins 
rio_bins <- read.csv(paste0("../../../RIOresults/", rioFolderName, "/binned_resource_df.csv"))
colnames(rio_bins)

#######################
# IMPORT CPA SHAPEFILES
## import merged_CPA_focalStats_APVupdate.csv
#CPA_merged_csv <- read.csv("../../../SupplyCurveAnalysis/multiTechCPAs/mergedCPAs_focalStats_v2/merged_CPA_focalStats.csv", stringsAsFactors = FALSE)

## import merged CPA shapefiles as sf objects
CPA_1 <- st_read(file.path(popNat_google_fp, "CPA_GISfiles/merged_CPA_focalStats_1_800000.shp"), stringsAsFactors = FALSE) 
CPA_2 <- st_read(file.path(popNat_google_fp,"CPA_GISfiles/merged_CPA_focalStats_800001_1600000.shp"), stringsAsFactors = FALSE)
CPA_3 <- st_read(file.path(popNat_google_fp, "CPA_GISfiles/merged_CPA_focalStats_1600001_plus.shp"), stringsAsFactors = FALSE)

## import spur lines
#spurs_1 <- st_read(paste0("../../../SupplyCurveAnalysis/Tx/", leastCostPath_folderName, "/LCP_costing_mergedSubID_1_1200000.shp"), stringsAsFactors = FALSE)
#spurs_2 <- st_read(paste0("../../../SupplyCurveAnalysis/Tx/", leastCostPath_folderName, "/LCP_costing_mergedSubID_1200001_plus.shp"), stringsAsFactors = FALSE)

# Read the feature class from geodatabase
fgdb = paste0("../../../SupplyCurveAnalysis/Tx/", leastCostPath_folderName,  "/outPaths_115_increments.gdb")
fc_list = ogrListLayers(fgdb) 
print(fc_list) 
#spurs = readOGR(dsn=fgdb,layer= "LCP_costing_mergedSubID") 
spurs = st_read(fgdb, "LCP_costing_mergedSubID") 

## Import SVI attributes
#SVI_CPA_df <- read.csv("../../../SupplyCurveAnalysis/attributeData/", zonalStats_folderName, "/SVI2020.csv")

#######################
# IMPORT CPAS AS RASTER
CPAs_ras <- raster(file.path(popNat_google_fp, "CPA_GISfiles/merged_CPA_focalStats_v2_ras.tif"))

```

########################################
# STEP 3b: join prediction values to binned df and calculate mean prediction score for colocation (wind and solar)
```{r}
######################################
## Zonal stats for prediction surfaces

fixExtent <- function(template, in_ras){
  e <- extent(template)
  ## https://gis.stackexchange.com/questions/158159/snapping-raster-grids-in-r
  in_ras = resample(in_ras, template, "bilinear")
  in_ras <- crop(in_ras, e)
  
  if(sum(as.matrix(extent(in_ras))!=as.matrix(e)) == 0){ # edited
    in_ras_mask <- mask(in_ras, template) # You can't mask with extent, only with a Raster layer, RStack or RBrick
  }else{
    in_ras <- extend(in_ras, template)
    in_ras_mask <- mask(in_ras, template)
  }
  return(in_ras_mask)
}

predPV.ras.fixed <- fixExtent(CPAs_ras, pred_PV)
predPV_CPA_df <- as.data.frame(zonal(x = predPV.ras.fixed, z = CPAs_ras, fun ='mean', na.rm = TRUE))

predWind.ras.fixed <- fixExtent(CPAs_ras, pred_PV)
predWind_CPA_df <- as.data.frame(zonal(x = predWind.ras.fixed, z = CPAs_ras, fun ='mean', na.rm = TRUE))


## filter rio bin rows to onshore wind and solar using uniqueID
rio_bins <- rio_bins %>% 
  drop_na(UNIQUEID)

nrow(rio_bins)

## join the random forest prediction values and the SVI zonal stats attributes
rio_bins <- rio_bins %>% 
  select(-c(rf_PV, rf_wind)) %>% ## drop old prediction values
  rename(STATE_sub = STATE) %>%
  left_join(pred_PV, by = c("UNIQUEID"= "UNIQUEID")) %>%
  left_join(pred_wind, by = c("UNIQUEID"= "UNIQUEID")) #%>%
  #left_join(SVI_CPA_df, by = c("UNIQUEID"= "UNIQUEID"))

## determine how many CPAs have no prediction values
rio_bins_pred <- rio_bins %>% 
  drop_na(rf_PV)

print(paste("Number of CPAs missing prediction values:", toString(nrow(rio_bins) - nrow(rio_bins_pred))))

rm(rio_bins, pred_PV, pred_wind)

rio_bins_pred <- rio_bins_pred %>% 
  mutate(rf_both = rowMeans(select(rio_bins_pred, c(rf_PV, rf_wind)), na.rm = TRUE))

## calculate new total capacity fields for colocation and trilocation:
rio_bins_pred <- rio_bins_pred %>% 
  mutate(MW_CO_tot = MW_CO_wi_1*3) #%>% ##1:2 ratio of capacity wind:solar, therefore wind x3 = total capacity
  #mutate(MW_tri_tot = rowSums(select(rio_bins_pred, c(MW_CO_fi_1, MW_CO_wi_1)), na.rm = TRUE))

```


########################################
# STEP 4: Prep the lists for looping and subset the rio results df
```{r}
## get list of zones, bin numbers, and scenarios
zone.list <- unique(rio_bins_pred$gau)
bin.list <- unique(rio_bins_pred$bin_number)
scenario.list <- unique(rio_cap$run.name)
tech.list <- unique(rio_cap$tech..outputs_group_aggregate)
colnames(rio_cap)
year.list <- unique(rio_cap$year)
#tech.list.select <- c("fixed pv+agriculture", "fixed pv+wind+agriculture","wind+tracking pv","onshore wind", "fixed pv", "tracking pv")
tech.list.select <- c("fixed pv+agriculture", "wind+tracking pv","onshore wind", "fixed pv", "tracking pv")

  ## postprocess rio results (capacity) to filter by technology and isolate the bins from the technology
# filter rio results to technology and create column with just the bin numbers
rio_cap_sub <- rio_cap %>%
  ## select just onshore wind (need to replace the subscript with space)
  filter(tech..outputs_group_detailed %in% tech.list.select) %>%
  ## create new column with just bins numbers; use the "look around" regex: https://cran.r-project.org/web/packages/stringr/vignettes/regular-expressions.html
  mutate(bin_number = as.numeric(str_extract(tech, "(?<=|\\s)\\d+"))) %>%
  filter(!grepl('existing', tech)) %>%
  select(c(run.name, year, tech..outputs_group_detailed, zone, bin_number, value)) %>%
  rename(technology = tech..outputs_group_detailed)
  # filter(run.name=="reference")

## QA/QC: 
## check that there are no duplicates 
rio_sub_final <- rio_cap_sub %>%
  group_by(run.name, year, technology, zone, bin_number) %>%
  summarize(value.total = sum(value))
nrow(rio_sub_final) == nrow(rio_cap_sub)
  #filter(year == 2040 & zone == "arizona" & bin_number == 1 & run.name == "high elec level 1")

## find duplicated rows
rio_cap_sub_noVal <- rio_cap_sub %>%
  select(-value)
#test <- rio_cap_sub_noVal[duplicated(rio_cap_sub_noVal),]

## filter
filteredRows = rio_cap_sub %>%
  filter(run.name == "100p", year == "2027", technology == "onshore wind", zone == "central great plains_emm", bin_number == "1")
```


## rules for technology combinations and corresopnding selected technology
tech_combo_group or the CPA flags (bins)     |   technology (results)
"solar+agriculture"  --->  "fixed pv+agriculture"
"solar+wind+agriculture" --->  "fixed pv+wind+agriculture"

Run in order:
1. "wind available" & CPA_solar == 1 ---> "wind+tracking pv" 
2. after removing all of 1 above: "wind available" ---> "onshore wind"
3. after removing all of 1 and 2 above: CPA_solar == 1 ---> "fixed pv"
4. after removing 1, 2, and 3 above: CPA_solar == 1 ---> "tracking pv"

For each technology in the results (rio_cap_sub), subset the supply curve (rio_bins_pred), removing previously selected CPAs as necessary

########################################
# STEP 5: CREATE NEW FIELDS FOR EACH SCENARIO AND YEAR COMBINATION IN CPA FC WITH VALUE = 1 IF CPA IS SELECTED
```{r}
## FOR TESTING THE BELOW CODE
#zone <- "montana"#"new mexico"
#bin <- 1
#scenario <- "high elec level 1"
year.list = c(2050)
yr = 2035

## subset scenarios
scenario.list <- unique(rio_cap$run.name)
scenario.list <- c("30p", "100p")

## create empty results list for CPAs
results.scen.list <- list()

# SORT CPAS BY PREDICTION SCORE FOR EACH BIN FOR EACH STATE and for each unique scenario and year combination, select the CPAs
for(scen in scenario.list){
  ## Set output csv filename for each technology
  resultsCSV_scen <- paste0(outputsFolder, scen, "_", toString(yr), "_allTech", ".csv")

  for(tech in tech.list.select){
    tic(paste(scen, tech))
    print(paste("===== > WORKING ON", tech))
    ## ===== filter the RESULTS to the technology and scenario
    rio_cap_sub_loop <- rio_cap_sub %>%
      filter(run.name == !!scen, technology == !!tech, year == !!yr)
    
    ## ====== filter the BINS/SUPPLY to the technology and set the rf score fieldname and solar and wind capacity fieldnames
    if(tech == "fixed pv+agriculture"){
      techFN <- "APV"
      rio_bins_pred_tech <-filter(rio_bins_pred, tech_combo_group == "solar+agriculture")
      scoreField <- "rf_PV"
      solarCapacityField <- "MW_APV_tr"
      windCapacityField <- NA
      capacityField <- solarCapacityField
    }
    # if(tech == "fixed pv+wind+agriculture"){
    #   techFN <- "trilocation"
    #   rio_bins_pred_tech <-filter(rio_bins_pred, tech_combo_group == "solar+wind+agriculture")
    #   scoreField <- "rf_both"
    #   solarCapacityField <- "MW_APV_fi"
    #   windCapacityField <- "MW_CO_wi_7"
    #   capacityField <- "MW_tri_tot"
    # }
    if(tech =="wind+tracking pv"){
      techFN <- "colocation"
      rio_bins_pred_tech <-filter(rio_bins_pred, CPA_wind == 1 & CPA_solar == 1)
      scoreField <- "rf_both"
      solarCapacityField <- "MW_CO_tr_1"
      windCapacityField <- "MW_CO_wi_1"
      capacityField <- "MW_CO_tot"
    }
    if(tech == "onshore wind"){
      techFN <- "onshoreWind"
      rio_bins_pred_tech <- filter(rio_bins_pred, CPA_wind == 1)
      ## REMOVE CPAs selected earlier (colocated)
      colocation_df <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "colocation", ".csv"), show_col_types = FALSE)
      rio_bins_pred_tech <- rio_bins_pred_tech[!(rio_bins_pred_tech$UNIQUEID %in% colocation_df$UNIQUEID),]
      scoreField <- "rf_wind"
      solarCapacityField <- NA
      windCapacityField <- "MW_WO_wi"
      capacityField <- windCapacityField
    }
    if(tech == "fixed pv"){
      techFN <- "fixedPV"
      rio_bins_pred_tech <-filter(rio_bins_pred, CPA_solar == 1)
      ## REMOVE CPAs selected earlier (colocated, wind only)
      #colocation_df <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "colocation", ".csv"), show_col_types = FALSE)
      #windOnly_df <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "onshoreWind", ".csv"), show_col_types = FALSE)
      ## combine CPAs selected earlier
      #combList <- c(colocation_df$UNIQUEID, windOnly_df$UNIQUEID)
      #rio_bins_pred_tech <- rio_bins_pred_tech[!(rio_bins_pred_tech$UNIQUEID %in% combList),]
      rio_bins_pred_tech <- filter(rio_bins_pred, tech_combo_group == "solar alone")
      scoreField <- "rf_PV"
      solarCapacityField <- "MW_SO_fi"
      windCapacityField <- NA
      capacityField <- solarCapacityField
    }
    if(tech == "tracking pv"){
      techFN <- "trackingPV"
      rio_bins_pred_tech <-filter(rio_bins_pred, CPA_solar == 1)
      ## REMOVE CPAs selected earlier (colocated, wind only, fixed PV)
      #colocation_df <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "colocation", ".csv"), show_col_types = FALSE)
      #windOnly_df <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "onshoreWind", ".csv"), show_col_types = FALSE)
      fixedPV_df <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "fixedPV", ".csv"), show_col_types = FALSE)
      ## combine CPAs selected earlier
      #combList <- c(colocation_df$UNIQUEID, windOnly_df$UNIQUEID, fixedPV_df$UNIQUEID)
      rio_bins_pred_tech <- rio_bins_pred_tech[!(rio_bins_pred_tech$UNIQUEID %in% fixedPV_df$UNIQUEID),]
      scoreField <- "rf_PV"
      solarCapacityField <- "MW_SO_tr"
      windCapacityField <- NA
      capacityField <- solarCapacityField
    }
    
    ### ==== SET OUTPUT DF LISTS AND CSV FILEPATHS
    ## create empty results list for CPAs
    results.tech.list <- list()
    ## Set output csv filename for each technology
    resultsCSV_tech <- paste0(outputsFolder, scen, "_", toString(yr), "_", techFN, ".csv")
    ## Set output CPA  filename for each technology
    resultsSHP_CPA_tech <- paste0(outputsFolder_shp, scen, "_", toString(yr), "_", techFN, "_CPA.shp")
    ## Set output spur  filename for each technology
    resultsSHP_spur_tech <- paste0(outputsFolder_shp, scen, "_", toString(yr), "_", techFN, "_spur.shp")
    ## create empty df for residuals
    residuals.df <- setNames(data.frame(matrix(ncol = 5, nrow = 0)), c("scenario", "zone", "bin", "residual_MW", "residual_percentage"))
    residuals_CSV <- paste0(outputsFolder, "diagnostics/", "residuals_", scen, "_", toString(yr), "_", techFN, ".csv")
    ## create empty df for bins-zones with insufficient CPAs
    insufficientCPAs.df <- setNames(data.frame(matrix(ncol = 4, nrow = 0)), c("scenario", "zone", "bin", "neededMW"))
    insufficientCPAs_CSV <- paste0(outputsFolder, "diagnostics/", "insufficientCPAs_", scen, "_", toString(yr), "_", techFN, ".csv")

    ## get list of zones
    zone.list <- unique(rio_cap_sub_loop$zone)
    ## get list of bins
    bin.list <- unique(rio_cap_sub_loop$bin_number)

    for(zone in zone.list){
      for(bin in bin.list){
        
        print(paste(" ====> Working on ", tech ,"for zone", zone, "and bin", toString(bin), sep=" "))
        
        # create a subset of CPA_join for each bin and zone combination, sorted [by highest to lowest (highest) or 
        # lowest to highest (lowest) score], and with the cumulative sum
        rio_bins_pred_sub <- rio_bins_pred_tech %>%
          filter(bin_number == !!bin & gau == !!zone) %>%
          mutate(tech = !!techFN) %>%
          arrange(-!!as.name(scoreField)) %>%
          mutate(cumsum = cumsum(UQ(rlang::sym(capacityField)))) # https://stackoverflow.com/questions/26003574/use-dynamic-name-for-new-column-variable-in-dplyr
        
        ## Calculate the cumulative sum of capacity for each technology
        #if(!is.na(solarCapacityField)){
        #  rio_bins_pred_sub <- rio_bins_pred_sub %>%
        #    mutate(cumsum_solar = cumsum(solarCapacityField))}
        #if(!is.na(solarCapacityField)){
        #  rio_bins_pred_sub <- rio_bins_pred_sub %>%
        #    mutate(cumsum_wind = cumsum(windCapacityField))}
        
        ## ====> get DEMAND (RESULTS) for the zone and bin
        demand <- rio_cap_sub_loop %>%
          filter(zone == !!zone & bin_number == !!bin)
        
        ## if filtering worked correctly and there is one value for each zone bin combination:
        if(dim(demand)[1] == 1){
          print(paste("Working on zone:", zone, "bin:", toString(bin), "scenario:", scen, "year:", toString(yr), sep=" "))
          
          MW <- demand$value*1000 ## in MW of capacity
          
          ## If there are no CPAs available/left in this bin-zone combination, then skip, but save this information in a df 
          if(nrow(rio_bins_pred_sub) == 0){
              print(paste("***** ALERT! There are no CPAs left in Zone", zone, "and bin", toString(bin) ,sep=" "))
              insufficientCPAs.newRow <- data.frame(scenario = scen, zone = zone, bin = bin, neededMW = MW)
              insufficientCPAs.df <- rbind(insufficientCPAs.df, insufficientCPAs.newRow)
          }else{
          
            ## Create field name with scenario name and year
            fieldName <- paste(scen, str_sub(toString(yr),start=-2), sep = "_")
            
            ## if demand is greater than zero, then select sites
            if(MW > 0){
              ## identify all rows with cumsum values less than or equal to GWh + 1 additional CPA
              rio_bins_pred_sub.selected <- rio_bins_pred_sub %>%
                mutate(!!fieldName := ifelse(cumsum <= !!MW, 1, 0))
              
              ## get the maximum index value of the selected sites and the total CPAs in this zone-bin combination
              indexMax.selected <- dim(filter(rio_bins_pred_sub.selected, !!as.name(fieldName) == 1))[1]
              indexMax.all <- dim(rio_bins_pred_sub.selected)[1]
              
              ## if there are fewer CPAs selected than the available, then select the marginal CPA
              if(indexMax.selected < indexMax.all){
                print("Selecting marginal CPA")
                rio_bins_pred_sub.selected <- rio_bins_pred_sub.selected %>%
                  mutate(!!as.name(fieldName) := ifelse(row_number() == indexMax.selected + 1, 1, !!as.name(fieldName)))
                ## calculate the residual
                residual <- rio_bins_pred_sub.selected[[indexMax.selected + 1, "cumsum"]] - MW 
                residuals.df.newRow <- data.frame(scenario = fieldName, zone = zone, 
                                                  bin = bin, residual_MW = residual, residual_percentage = residual/MW)
                residuals.df <- rbind(residuals.df, residuals.df.newRow)
                
              ## if the number of CPAs selected is the amount available, then just calculate the residual
              }else if(indexMax.selected == indexMax.all){
                print("maximum number of CPAs selected, calculate residual")
                residual <- rio_bins_pred_sub.selected[[indexMax.selected, "cumsum"]] - MW
                residuals.df.newRow <- data.frame(scenario = fieldName, zone = zone, 
                                                  bin = bin, residual_MW = residual, residual_percentage = residual/MW)
                residuals.df <- rbind(residuals.df, residuals.df.newRow)
              }
          
          ## Otherwise, there is no demand, and assign zeros to all CPAs for this scenario-year combination  
          }else{
            print("----> No demand")
            rio_bins_pred_sub.selected <- rio_bins_pred_sub %>%
              mutate(!!fieldName := 0)}
          
          ## select all fieldName == 1
          rio_bins_pred_sub.selected.1 <- filter(rio_bins_pred_sub.selected, UQ(rlang::sym(fieldName)) == 1)
          rio_bins_pred_sub <- rio_bins_pred_sub.selected.1
          } # close loop on if there are CPAs in the bins/supply
        } ## close loop on if there is demand for this scenario, year, tech, bin and zone
    
        ## add dataframe for this zone-bin combination to a list
        results.tech.list <- c(results.tech.list, list(rio_bins_pred_sub))
        
        # delete variables
        rm(list = c("rio_bins_pred_sub", "MW", "rio_bins_pred_sub.selected.1", "rio_bins_pred_sub.selected"))
      } ## close bin loop
    } ## close zone loop
    
    ## after looping through all zones and bins, combine all the selected rows/CPAs for each Tech and scenario
    selectedCPA_tech_scen <- bind_rows(results.tech.list)
    ## append to the scenario-wide list 
    #results.scen.list <- c(results.scen.list, selectedCPA_tech_scen)
    ## save technology results to csv
    write.csv(selectedCPA_tech_scen, resultsCSV_tech, row.names=FALSE)
    ## save insufficientCPAs.df to file
    write.csv(insufficientCPAs.df, insufficientCPAs_CSV, row.names=FALSE)
    ## save residuals.df to file
    write.csv(residuals.df, residuals_CSV, row.names=FALSE)
    
    tic("Saving CPA to shapefile")
    print("Selecting CPAs and writing to shapefile")
    ## join uniqueID to CPA sf object and export results as shapefiles
    selectedCPA_tech_scen <- select(selectedCPA_tech_scen, any_of(c(keepFieldsList, capacityField))) %>%
      mutate(scen = !!fieldName) %>%
      rename("cap_tot_MW" = !!capacityField)
    CPA_1_select <- CPA_1 %>% inner_join(selectedCPA_tech_scen, by = c("UNIQUEID" = "UNIQUEID"))
    CPA_2_select <- CPA_2 %>% inner_join(selectedCPA_tech_scen, by = c("UNIQUEID" = "UNIQUEID"))
    CPA_3_select <- CPA_3 %>% inner_join(selectedCPA_tech_scen, by = c("UNIQUEID" = "UNIQUEID"))
    
    single_CPA_sf <- dplyr::bind_rows(list(CPA_1_select,CPA_2_select,CPA_3_select))
    ## Save to shapefile
    st_write(single_CPA_sf, resultsSHP_CPA_tech, append=FALSE)
    rm(single_CPA_sf, CPA_1_select, CPA_2_select, CPA_3_select)
    toc()
    
    tic("Saving spurs to shapefile")
    print("Selecting SPURS and writing to shapefile")
    ## select the spur lines
    #spurs_1_select <- spurs_1 %>% filter(DestID %in% selectedCPA_tech_scen$UNIQUEID) %>%
    #  mutate(scen = !!fieldName)
    #spurs_2_select <- spurs_2 %>% filter(DestID %in% selectedCPA_tech_scen$UNIQUEID) %>%
    #  mutate(scen = !!fieldName)
    #single_spurs_sf <- dplyr::bind_rows(list(spurs_1_select,spurs_2_select))
    spurs_select <- spurs %>% filter(DestID %in% selectedCPA_tech_scen$UNIQUEID) %>%
      mutate(scen = !!fieldName)
    ## drop z dimension
    spurs_select <- st_zm(spurs_select, drop=T, what='ZM')
    ## Save to shapefile
    st_write(spurs_select, resultsSHP_spur_tech, append=FALSE)
    #rm(spurs_1_select, spurs_2_select, single_spurs_sf)
    rm(spurs_select)
    toc()
    
    ## delete variables:
    rm(list = c("rio_cap_sub_loop", "techFN", "rio_bins_pred_tech", "scoreField", "solarCapacityField", "windCapacityField","capacityField"))
    toc()
    
  } ## close tech loop
  ## bind all the dataframe subsets together by row
  #selectedCPA_scen <- bind_rows(results.scen.list)
  ## save scenario results to csv
  #write.csv(selectedCPA_scen, resultsCSV_scen, row.names=FALSE)
  
} ## close scenario loop

```


# PLOTS: Generate histograms of SVI distributions for entire  supply curve
```{r}
## group SVI metrics into bins (10 bins, 10% in each bin)
rio_bins_pred_SVI <- rio_bins_pred %>%
  select(CPA_wind, CPA_solar, CPA_APV2, MW_WO_wi, MW_SO_fi, MW_SO_tr, MW_APV_tr, MW_CO_tot, pov, unemp, minrty, nohsdp) %>%
  mutate(pov_bin = cut(pov, breaks=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))) %>%
  mutate(unemp_bin = cut(unemp, breaks=c(0, 5, 10, 15, 20, 25, 30, 35, 40))) %>%
  mutate(minrty_bin = cut(minrty, breaks=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))) %>%
  mutate(nohsdp_bin = cut(nohsdp, breaks=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)))

pov_df <- rio_bins_pred_SVI %>%
  select(-c(unemp_bin, minrty_bin, nohsdp_bin)) %>%
  group_by(pov_bin, CPA_wind, CPA_solar, CPA_APV2) %>%
  summarize(sum_MW_WO_wi = sum(MW_WO_wi),
            sum_MW_SO_fi = sum(MW_SO_fi),
            sum_MW_SO_tr = sum(MW_SO_tr),
            sum_MW_APV_tr = sum(MW_APV_tr),
            sum_MW_CO_tot = sum(MW_CO_tot)) %>%
  pivot_longer(cols = c(sum_MW_WO_wi, sum_MW_SO_fi, sum_MW_SO_tr, sum_MW_APV_tr, sum_MW_CO_tot), names_to = "technology", values_to = "sum_MW")

unemp_df <- rio_bins_pred_SVI %>%
  select(-c(pov_bin, minrty_bin, nohsdp_bin)) %>%
  group_by(unemp_bin, CPA_wind, CPA_solar, CPA_APV2) %>%
  summarize(sum_MW_WO_wi = sum(MW_WO_wi),
            sum_MW_SO_fi = sum(MW_SO_fi),
            sum_MW_SO_tr = sum(MW_SO_tr),
            sum_MW_APV_tr = sum(MW_APV_tr),
            sum_MW_CO_tot = sum(MW_CO_tot)) %>%
  pivot_longer(cols = c(sum_MW_WO_wi, sum_MW_SO_fi, sum_MW_SO_tr, sum_MW_APV_tr, sum_MW_CO_tot), names_to = "technology", values_to = "sum_MW")

minrty_df <- rio_bins_pred_SVI %>%
  select(-c(pov_bin, unemp_bin, nohsdp_bin)) %>%
  group_by(minrty_bin, CPA_wind, CPA_solar, CPA_APV2) %>%
  summarize(sum_MW_WO_wi = sum(MW_WO_wi),
            sum_MW_SO_fi = sum(MW_SO_fi),
            sum_MW_SO_tr = sum(MW_SO_tr),
            sum_MW_APV_tr = sum(MW_APV_tr),
            sum_MW_CO_tot = sum(MW_CO_tot)) %>%
  pivot_longer(cols = c(sum_MW_WO_wi, sum_MW_SO_fi, sum_MW_SO_tr, sum_MW_APV_tr, sum_MW_CO_tot), names_to = "technology", values_to = "sum_MW")

nohsdp_df <- rio_bins_pred_SVI %>%
  select(-c(pov_bin, unemp_bin, minrty_bin)) %>%
  group_by(nohsdp_bin, CPA_wind, CPA_solar, CPA_APV2) %>%
  summarize(sum_MW_WO_wi = sum(MW_WO_wi),
            sum_MW_SO_fi = sum(MW_SO_fi),
            sum_MW_SO_tr = sum(MW_SO_tr),
            sum_MW_APV_tr = sum(MW_APV_tr),
            sum_MW_CO_tot = sum(MW_CO_tot)) %>%
  pivot_longer(cols = c(sum_MW_WO_wi, sum_MW_SO_fi, sum_MW_SO_tr, sum_MW_APV_tr, sum_MW_CO_tot), names_to = "technology", values_to = "sum_MW")
```

POVERTY
```{r}
pov_wind <- pov_df %>%
  filter(CPA_wind == 1 & technology == "sum_MW_WO_wi") %>%
  ggplot(aes(x = pov_bin, y = sum_MW))+
    geom_bar(stat = 'identity') + labs(title="poverty - wind")

pov_solar <- pov_df %>%
  filter(CPA_solar == 1 & technology == "sum_MW_SO_tr") %>%
  ggplot(aes(x = pov_bin, y = sum_MW))+
    geom_bar(stat = 'identity') + labs(title="poverty - solar")

pov_APV <- pov_df %>%
  filter(CPA_APV2 == 1 & technology == "sum_MW_SO_tr") %>%
  ggplot(aes(x = pov_bin, y = sum_MW))+
    geom_bar(stat = 'identity') + labs(title="poverty - APV")

grid.arrange(pov_wind, pov_solar, pov_APV, nrow= 3)
```

UNEMPLOYMENT
```{r}
unemp_wind <- unemp_df %>%
  filter(CPA_wind == 1 & technology == "sum_MW_WO_wi") %>%
  ggplot(aes(x = unemp_bin, y = sum_MW))+
    geom_bar(stat = 'identity') + labs(title="Unemployment - wind")

unemp_solar <- unemp_df %>%
  filter(CPA_solar == 1 & technology == "sum_MW_SO_tr") %>%
  ggplot(aes(x = unemp_bin, y = sum_MW))+
    geom_bar(stat = 'identity') + labs(title="Unemployment - solar")

unemp_APV <- unemp_df %>%
  filter(CPA_APV2 == 1 & technology == "sum_MW_SO_tr") %>%
  ggplot(aes(x = unemp_bin, y = sum_MW))+
    geom_bar(stat = 'identity') + labs(title="Unemployment - APV")

grid.arrange(unemp_wind, unemp_solar, unemp_APV, nrow= 3)
```

MINORITY
```{r}
minority_wind <- minrty_df %>%
  filter(CPA_wind == 1 & technology == "sum_MW_WO_wi") %>%
  ggplot(aes(x = minrty_bin, y = sum_MW))+
    geom_bar(stat = 'identity') + labs(title="Minority - wind")

minority_solar <- minrty_df %>%
  filter(CPA_solar == 1 & technology == "sum_MW_SO_tr") %>%
  ggplot(aes(x = minrty_bin, y = sum_MW))+
    geom_bar(stat = 'identity') + labs(title="Minority - solar")

minority_APV <- minrty_df %>%
  filter(CPA_APV2 == 1 & technology == "sum_MW_SO_tr") %>%
  ggplot(aes(x = minrty_bin, y = sum_MW))+
    geom_bar(stat = 'identity') + labs(title="Minority - APV")

grid.arrange(minority_wind, minority_solar, minority_APV, nrow= 3)
```

NO HS DIPLOMA
```{r}
nohsdp_wind <- nohsdp_df %>%
  filter(CPA_wind == 1 & technology == "sum_MW_WO_wi") %>%
  ggplot(aes(x = nohsdp_bin, y = sum_MW))+
    geom_bar(stat = 'identity')

nohsdp_solar <- nohsdp_df %>%
  filter(CPA_solar == 1 & technology == "sum_MW_SO_tr") %>%
  ggplot(aes(x = nohsdp_bin, y = sum_MW))+
    geom_bar(stat = 'identity')

nohsdp_APV <- nohsdp_df %>%
  filter(CPA_APV2 == 1 & technology == "sum_MW_SO_tr") %>%
  ggplot(aes(x = nohsdp_bin, y = sum_MW))+
    geom_bar(stat = 'identity')
nohsdp_wind
nohsdp_solar
nohsdp_APV
```


# PLOTS: Barplots for results

## 10p - 2050 - tracking PV
```{r}
scen <- "10p"
yr <- "2050"

trackingPV_results <- st_read(paste0(outputsFolder_shp, scen, "_", toString(yr), "_", techFN, "_CPA.shp"), stringsAsFactors = FALSE)

trackingPV_10p_2050 <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "trackingPV", ".csv"))
fixedPV_10p_2050 <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "fixedPV", ".csv"))
onshoreWind_10p_2050 <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "onshoreWind", ".csv"))
APV_10p_2050 <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "APV", ".csv"))
colocation_10p_2050 <- read_csv(paste0(outputsFolder, scen, "_", toString(yr), "_", "colocation", ".csv"))

## group SVI metrics into bins (10 bins, 10% in each bin)
rio_bins_pred_SVI <- rio_bins_pred %>%
  select(CPA_wind, CPA_solar, CPA_APV2, MW_WO_wi, MW_SO_fi, MW_SO_tr, MW_APV_tr, MW_CO_tot, pov, unemp, minrty, nohsdp) %>%
  mutate(pov_bin = cut(pov, breaks=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))) %>%
  mutate(unemp_bin = cut(unemp, breaks=c(0, 5, 10, 15, 20, 25, 30, 35, 40))) %>%
  mutate(minrty_bin = cut(minrty, breaks=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))) %>%
  mutate(nohsdp_bin = cut(nohsdp, breaks=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)))

pov_df <- rio_bins_pred_SVI %>%
  select(-c(unemp_bin, minrty_bin, nohsdp_bin)) %>%
  group_by(pov_bin, CPA_wind, CPA_solar, CPA_APV2) %>%
  summarize(sum_MW_WO_wi = sum(MW_WO_wi),
            sum_MW_SO_fi = sum(MW_SO_fi),
            sum_MW_SO_tr = sum(MW_SO_tr),
            sum_MW_APV_tr = sum(MW_APV_tr),
            sum_MW_CO_tot = sum(MW_CO_tot)) %>%
  pivot_longer(cols = c(sum_MW_WO_wi, sum_MW_SO_fi, sum_MW_SO_tr, sum_MW_APV_tr, sum_MW_CO_tot), names_to = "technology", values_to = "sum_MW")

unemp_df <- rio_bins_pred_SVI %>%
  select(-c(pov_bin, minrty_bin, nohsdp_bin)) %>%
  group_by(unemp_bin, CPA_wind, CPA_solar, CPA_APV2) %>%
  summarize(sum_MW_WO_wi = sum(MW_WO_wi),
            sum_MW_SO_fi = sum(MW_SO_fi),
            sum_MW_SO_tr = sum(MW_SO_tr),
            sum_MW_APV_tr = sum(MW_APV_tr),
            sum_MW_CO_tot = sum(MW_CO_tot)) %>%
  pivot_longer(cols = c(sum_MW_WO_wi, sum_MW_SO_fi, sum_MW_SO_tr, sum_MW_APV_tr, sum_MW_CO_tot), names_to = "technology", values_to = "sum_MW")

minrty_df <- rio_bins_pred_SVI %>%
  select(-c(pov_bin, unemp_bin, nohsdp_bin)) %>%
  group_by(minrty_bin, CPA_wind, CPA_solar, CPA_APV2) %>%
  summarize(sum_MW_WO_wi = sum(MW_WO_wi),
            sum_MW_SO_fi = sum(MW_SO_fi),
            sum_MW_SO_tr = sum(MW_SO_tr),
            sum_MW_APV_tr = sum(MW_APV_tr),
            sum_MW_CO_tot = sum(MW_CO_tot)) %>%
  pivot_longer(cols = c(sum_MW_WO_wi, sum_MW_SO_fi, sum_MW_SO_tr, sum_MW_APV_tr, sum_MW_CO_tot), names_to = "technology", values_to = "sum_MW")

nohsdp_df <- rio_bins_pred_SVI %>%
  select(-c(pov_bin, unemp_bin, minrty_bin)) %>%
  group_by(nohsdp_bin, CPA_wind, CPA_solar, CPA_APV2) %>%
  summarize(sum_MW_WO_wi = sum(MW_WO_wi),
            sum_MW_SO_fi = sum(MW_SO_fi),
            sum_MW_SO_tr = sum(MW_SO_tr),
            sum_MW_APV_tr = sum(MW_APV_tr),
            sum_MW_CO_tot = sum(MW_CO_tot)) %>%
  pivot_longer(cols = c(sum_MW_WO_wi, sum_MW_SO_fi, sum_MW_SO_tr, sum_MW_APV_tr, sum_MW_CO_tot), names_to = "technology", values_to = "sum_MW")



```
## One-time code
```{r}
rio_bins_pred_sub <- select(rio_bins_pred, any_of(c(keepFieldsList)))

CPA_1_select <- CPA_1 %>% inner_join(rio_bins_pred_sub, by = c("UNIQUEID" = "UNIQUEID"))
CPA_2_select <- CPA_2 %>% inner_join(rio_bins_pred_sub, by = c("UNIQUEID" = "UNIQUEID"))
CPA_3_select <- CPA_3 %>% inner_join(rio_bins_pred_sub, by = c("UNIQUEID" = "UNIQUEID"))

single_CPA_sf <- dplyr::bind_rows(list(CPA_1_select,CPA_2_select,CPA_3_select))
## Save to shapefile
st_write(single_CPA_sf, file.path("../../outputs/", "RIO_CPA_subset", "RIO_CPA_subset_122822.shp"), append=FALSE)
rm(single_CPA_sf, CPA_1_select, CPA_2_select, CPA_3_select)

```

